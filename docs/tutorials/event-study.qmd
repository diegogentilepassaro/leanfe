---
title: "Event Studies"
subtitle: "Dynamic treatment effects over time"
---

## Overview

Event studies extend difference-in-differences to examine how treatment effects evolve over time. This tutorial covers:

- Creating lead and lag indicators
- Specifying event study models
- Choosing the reference period
- Plotting event study coefficients

## The Event Study Design

Instead of a single `treated_post` indicator, event studies use separate indicators for each period relative to treatment:

- **Leads** (pre-treatment): Test parallel trends assumption
- **Lags** (post-treatment): Show dynamic treatment effects

## Creating Event Time Variables

```{python}
#| echo: true
#| output: true

import numpy as np
import polars as pl
from leanfe import leanfe

np.random.seed(42)

# Setup: 100 units, 20 periods
n_units = 100
n_periods = 20
treatment_period = 10  # Treatment occurs at period 10

# 50 units get treated
treated_units = list(range(1, 51))

# Generate panel with dynamic treatment effects
# Effect grows over time: 0 pre-treatment, then 1, 2, 3, ... post-treatment
data = []
for unit in range(1, n_units + 1):
    unit_fe = np.random.normal(0, 2)
    is_treated = unit in treated_units
    
    for period in range(1, n_periods + 1):
        period_fe = np.random.normal(0, 0.5)
        
        # Event time (relative to treatment)
        event_time = period - treatment_period if is_treated else None
        
        # Dynamic treatment effect (grows linearly post-treatment)
        if is_treated and period >= treatment_period:
            true_effect = (period - treatment_period + 1) * 0.5  # 0.5, 1.0, 1.5, ...
        else:
            true_effect = 0
        
        y = true_effect + unit_fe + period_fe + np.random.normal(0, 1)
        
        data.append({
            "unit_id": unit,
            "period": period,
            "event_time": event_time,
            "treated": float(is_treated),
            "y": y
        })

df = pl.DataFrame(data)
print(f"Panel: {df.shape[0]} observations")
print(f"Event time range: {df.filter(pl.col('event_time').is_not_null())['event_time'].min()} to {df.filter(pl.col('event_time').is_not_null())['event_time'].max()}")
```

## Creating Lead/Lag Indicators

Create dummy variables for each event time period:

```{python}
#| echo: true
#| output: true

# Create lead/lag dummies
# We'll use periods -5 to +5, with -1 as reference (omitted)
event_times = list(range(-5, 6))  # -5, -4, ..., 0, 1, ..., 5
reference_period = -1  # Omit period just before treatment

for et in event_times:
    if et == reference_period:
        continue  # Skip reference period
    col_name = f"et_{et}" if et < 0 else f"et_plus_{et}"
    df = df.with_columns(
        pl.when(pl.col("event_time") == et)
        .then(1.0)
        .otherwise(0.0)
        .alias(col_name)
    )

# Show the event time columns
et_cols = [c for c in df.columns if c.startswith("et_")]
print(f"Event time indicators: {et_cols}")
print(f"\nSample of data:")
print(df.filter(pl.col("unit_id") == 1).select(["period", "event_time"] + et_cols[:4]))
```

## Event Study Regression

```{python}
#| echo: true
#| output: true

# Build formula with all event time dummies
et_vars = " + ".join([c for c in df.columns if c.startswith("et_")])
formula = f"y ~ {et_vars} | unit_id + period"

print(f"Formula: {formula[:80]}...")

# Run event study regression
result = leanfe(
    formula=formula,
    data=df,
    vcov="cluster",
    cluster_cols=["unit_id"]
)

print(f"\nNumber of observations: {result['n_obs']}")
print(f"Number of clusters: {result['n_clusters']}")
```

## Extracting and Plotting Coefficients

```{python}
#| echo: true
#| output: true

import matplotlib.pyplot as plt

# Extract coefficients and SEs
coefs = []
for et in event_times:
    if et == reference_period:
        # Reference period: coefficient = 0 by construction
        coefs.append({"event_time": et, "coef": 0, "se": 0, "is_reference": True})
    else:
        col_name = f"et_{et}" if et < 0 else f"et_plus_{et}"
        if col_name in result['coefficients']:
            coefs.append({
                "event_time": et,
                "coef": result['coefficients'][col_name],
                "se": result['std_errors'][col_name],
                "is_reference": False
            })

coef_df = pl.DataFrame(coefs).sort("event_time")
print("Event study coefficients:")
print(coef_df)
```

```{python}
#| echo: true
#| output: true
#| fig-cap: "Event Study Plot"

# Create event study plot
fig, ax = plt.subplots(figsize=(10, 6))

et = coef_df["event_time"].to_numpy()
coef = coef_df["coef"].to_numpy()
se = coef_df["se"].to_numpy()

# Plot coefficients with confidence intervals
ax.errorbar(et, coef, yerr=1.96*se, fmt='o', capsize=3, capthick=1, 
            color='steelblue', markersize=8, label='Coefficient Â± 95% CI')

# Reference line at 0
ax.axhline(y=0, color='gray', linestyle='--', alpha=0.5)

# Vertical line at treatment
ax.axvline(x=0, color='red', linestyle='--', alpha=0.5, label='Treatment')

# Labels
ax.set_xlabel('Event Time (periods relative to treatment)', fontsize=12)
ax.set_ylabel('Coefficient', fontsize=12)
ax.set_title('Event Study: Dynamic Treatment Effects', fontsize=14)
ax.legend()
ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()
```

## Interpreting the Plot

- **Pre-treatment coefficients** (left of red line): Should be close to zero if parallel trends holds
- **Post-treatment coefficients** (right of red line): Show the dynamic treatment effect
- **Reference period** (et = -1): Normalized to zero

In our example, the growing post-treatment coefficients reflect the true dynamic effect we simulated.

## Choosing the Reference Period

Common choices:

| Reference | Rationale |
|-----------|-----------|
| `t = -1` | Period just before treatment (most common) |
| `t = -2` | Avoids anticipation effects |
| Average of pre-periods | More stable baseline |

## Summary

1. **Create event time**: Calculate periods relative to treatment
2. **Create dummies**: One indicator per event time period
3. **Omit reference**: Usually t = -1
4. **Estimate**: Include all dummies with unit and time FEs
5. **Plot**: Visualize coefficients with confidence intervals

## Next Steps

- [IV Regression](iv-regression.qmd) - Address endogeneity
- [Large Datasets](../guides/large-datasets.qmd) - Scale to big data
- [Benchmarks](../benchmarks/overview.qmd) - Performance comparisons
